---
- name: Application install - Git checkout
  ansible.builtin.git:
    repo: https://github.com/enwikipedia-acc/waca.git
    dest: "{{item}}"
    refspec: "pull/969/head"
    version: "{{app_version}}"
    recursive: false
    accept_hostkey: true
    force: yes

- name: Application install - folder permissions
  ansible.builtin.file:
    path: "{{item}}"
    state: directory
    mode: '2755'
    owner: root
    group: www-data

- name: Application install - templates_c
  ansible.builtin.file:
    path: "{{item}}/templates_c"
    state: directory
    mode: '0755'
    owner: www-data
    group: www-data

- name: Application install - vendor directory
  ansible.builtin.file:
    path: "{{item}}/vendor"
    state: directory
    mode: '0755'
    owner: www-data
    group: www-data

- name: Application install - node_modules directory
  ansible.builtin.file:
    path: "{{item}}/node_modules"
    state: directory
    mode: '0755'
    owner: www-data
    group: www-data

- name: Application install - package-lock.json permissions
  ansible.builtin.file:
    path: "{{item}}/package-lock.json"
    state: file
    mode: '0644'
    owner: www-data
    group: www-data

- name: Application install - errorlog directory
  ansible.builtin.file:
    path: "{{item}}/errorlog"
    state: directory
    mode: '0755'
    owner: www-data
    group: www-data

- name: Application install - Install composer dependencies
  become: true
  become_user: www-data
  become_method: sudo
  ansible.builtin.shell:
    cmd: bash -l -c 'export COMPOSER_HOME=/tmp; composer install'
    chdir: "{{item}}/"

- name: Application install - Install npm dependencies
  become: true
  become_user: www-data
  become_method: sudo
  ansible.builtin.shell: 
    cmd: bash -l -c 'npm i'
    chdir: "{{item}}/"

- name: Application install - Regenerate stylesheets
  become: true
  become_user: www-data
  become_method: sudo
  ansible.builtin.shell: 
    cmd: bash -l -c 'npm run build-scss'
    chdir: "{{item}}/"